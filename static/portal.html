<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç‚¹å• Agent è¿è¥ç›‘æ§ Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-nav {
            display: flex;
            gap: 1rem;
        }

        .header-nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .header-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Sidebar */
        .layout {
            display: flex;
        }

        .sidebar {
            width: 240px;
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            min-height: calc(100vh - 60px);
            padding: 1rem 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin: 0.25rem 0;
        }

        .sidebar-nav .nav-section {
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
            padding: 0 1.5rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-nav a:hover {
            background: var(--bg);
            color: var(--text);
        }

        .sidebar-nav a.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1), transparent);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        .sidebar-nav .icon {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        .metric-change {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .metric-change.up { color: var(--success); }
        .metric-change.down { color: var(--error); }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        /* Charts */
        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        tr:hover {
            background: var(--bg);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-error { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-pending { background: #e2e8f0; color: #475569; }
        .badge-secondary { background: #e2e8f0; color: #475569; }
        .badge-sm { font-size: 0.65rem; padding: 0.15rem 0.4rem; }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--bg-primary);
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { margin: 0; }
        .modal-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        .row-error {
            background-color: rgba(239, 68, 68, 0.1);
        }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .btn-close:hover { color: var(--text-primary); }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .form-group textarea {
            min-height: 80px;
            font-family: monospace;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .pagination {
            display: flex;
            gap: 0.25rem;
            padding: 1rem;
            justify-content: center;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Alerts */
        .alerts {
            margin-bottom: 1.5rem;
        }

        .alert {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .alert-error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }

        .alert-icon {
            font-size: 1.25rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .alert-action {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Activity List */
        .activity-list {
            list-style: none;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        .activity-icon.eval { background: #dbeafe; }
        .activity-icon.fix { background: #dcfce7; }
        .activity-icon.data { background: #fef3c7; }
        .activity-icon.optimize { background: #f3e8ff; }

        .activity-content {
            flex: 1;
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        select, input[type="text"] {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>AI ç‚¹å• Agent è¿è¥ç›‘æ§</h1>
        <nav class="header-nav">
            <a href="/intent">æ„å›¾åˆ†æ</a>
            <a href="/chat">å¤šè½®å¯¹è¯</a>
            <a href="/" class="active">è¿è¥ Portal</a>
        </nav>
        <div class="header-status">
            <span class="status-dot"></span>
            <span id="system-status">ç³»ç»Ÿæ­£å¸¸</span>
        </div>
    </header>

    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <!-- æ¦‚è§ˆ -->
                <li><a href="#overview" class="active" data-page="overview">
                    <span class="icon">ğŸ“Š</span> æ¦‚è§ˆ
                </a></li>

                <!-- è¯„ä¼°åˆ†æ -->
                <li class="nav-section">ğŸ“‹ è¯„ä¼°åˆ†æ</li>
                <li><a href="#evaluation" data-page="evaluation">
                    <span class="icon">ğŸ§ª</span> è¯„ä¼°ç®¡ç†
                </a></li>
                <li><a href="#confusion" data-page="confusion">
                    <span class="icon">ğŸ¯</span> æ··æ·†çŸ©é˜µ
                </a></li>
                <li><a href="#badcases" data-page="badcases">
                    <span class="icon">ğŸ›</span> Bad Case
                </a></li>

                <!-- æ•°æ®ç®¡ç† -->
                <li class="nav-section">ğŸ“¦ æ•°æ®ç®¡ç†</li>
                <li><a href="#samples" data-page="samples">
                    <span class="icon">ğŸ“</span> è®­ç»ƒæ ·æœ¬
                </a></li>
                <li><a href="#data" data-page="data">
                    <span class="icon">ğŸ“¦</span> æ•°æ®å¢å¼º
                </a></li>
                <li><a href="#sessions" data-page="sessions">
                    <span class="icon">ğŸ’¬</span> ä¼šè¯å›æ”¾
                </a></li>

                <!-- ä¼˜åŒ–å®éªŒ -->
                <li class="nav-section">ğŸ”¬ ä¼˜åŒ–å®éªŒ</li>
                <li><a href="#optimization" data-page="optimization">
                    <span class="icon">ğŸ“ˆ</span> ä¼˜åŒ–è¿½è¸ª
                </a></li>
                <li><a href="#abtesting" data-page="abtesting">
                    <span class="icon">ğŸ”¬</span> A/B æµ‹è¯•
                </a></li>

                <!-- ç³»ç»Ÿç›‘æ§ -->
                <li class="nav-section">ğŸ–¥ï¸ ç³»ç»Ÿç›‘æ§</li>
                <li><a href="#monitor" data-page="monitor">
                    <span class="icon">ğŸ”</span> å®æ—¶ç›‘æ§
                </a></li>
                <li><a href="#status" data-page="status">
                    <span class="icon">ğŸ’š</span> ç³»ç»ŸçŠ¶æ€
                </a></li>
                <li><a href="#business" data-page="business">
                    <span class="icon">ğŸ“ˆ</span> ä¸šåŠ¡çœ‹æ¿
                </a></li>
                <li><a href="#workflow" data-page="workflow">
                    <span class="icon">ğŸ”€</span> å·¥ä½œæµå›¾
                </a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main">
            <!-- Overview Page -->
            <div id="overview" class="page active">
                <h2 class="page-title">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h2>

                <!-- Alerts -->
                <div id="alerts" class="alerts"></div>

                <!-- Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">æ„å›¾å‡†ç¡®ç‡</div>
                        <div class="metric-value" id="metric-accuracy">--</div>
                        <div class="metric-change up" id="accuracy-change">-- --</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">æ§½ä½ F1</div>
                        <div class="metric-value" id="metric-slot-f1">--</div>
                        <div class="metric-change up" id="slot-f1-change">-- --</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Bad Case ç‡</div>
                        <div class="metric-value" id="metric-badcase-rate">--</div>
                        <div class="metric-change down" id="badcase-change">-- --</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">å¹³å‡ç½®ä¿¡åº¦</div>
                        <div class="metric-value" id="metric-confidence">--</div>
                        <div class="metric-change" id="confidence-change">-- --</div>
                    </div>
                </div>

                <!-- Charts and Activity -->
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">è¶‹åŠ¿å›¾</h3>
                            <select id="trend-metric" onchange="updateTrendChart()">
                                <option value="intent_accuracy">æ„å›¾å‡†ç¡®ç‡</option>
                                <option value="slot_f1">æ§½ä½ F1</option>
                                <option value="bad_case_rate">Bad Case ç‡</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="trend-chart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">æœ€è¿‘æ´»åŠ¨</h3>
                        </div>
                        <ul class="activity-list" id="activity-list"></ul>
                    </div>
                </div>

                <!-- Counts -->
                <div class="grid-3">
                    <div class="card">
                        <div class="card-title">å¾…å¤„ç† Bad Case</div>
                        <div class="metric-value" id="count-pending">--</div>
                    </div>
                    <div class="card">
                        <div class="card-title">ä¼˜åŒ–è½®æ¬¡</div>
                        <div class="metric-value" id="count-rounds">--</div>
                    </div>
                    <div class="card">
                        <div class="card-title">ç”Ÿäº§æ ·æœ¬æ•°</div>
                        <div class="metric-value" id="count-samples">--</div>
                    </div>
                </div>
            </div>

            <!-- Evaluation Page -->
            <div id="evaluation" class="page">
                <h2 class="page-title">ğŸ§ª è¯„ä¼°ç®¡ç†</h2>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">è¿è¡Œè¯„ä¼°</h3>
                        <button class="btn btn-primary" onclick="runEvaluation()">
                            â–¶ï¸ è¿è¡Œè¯„ä¼°
                        </button>
                    </div>

                    <div id="eval-status" style="display: none;">
                        <div style="margin-bottom: 0.5rem;">
                            <span id="eval-task">å‡†å¤‡ä¸­...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="eval-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">è¯„ä¼°å†å²</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>å¥—ä»¶</th>
                                    <th>é€šè¿‡/å¤±è´¥</th>
                                    <th>æ„å›¾å‡†ç¡®ç‡</th>
                                    <th>æ§½ä½ F1</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="eval-history"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bad Cases Page -->
            <div id="badcases" class="page">
                <h2 class="page-title">ğŸ› Bad Case ç®¡ç†</h2>

                <!-- å¿«é€Ÿæ“ä½œå·¥å…·æ  -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                        <h3 class="card-title" style="color: white;">ğŸš€ å¿«é€Ÿæ“ä½œ</h3>
                    </div>
                    <div style="padding: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" style="background: white; color: #667eea;" onclick="collectFromEvaluation()">
                            ğŸ“¥ ä»è¯„ä¼°æ”¶é›†
                        </button>
                        <button class="btn" style="background: white; color: #667eea;" onclick="showAddBadCaseModal()">
                            â• æ‰‹åŠ¨æ·»åŠ 
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5);" onclick="batchAnalyze()">
                            ğŸ” æ‰¹é‡åˆ†æ
                        </button>
                        <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5);" onclick="generateFixSuggestions()">
                            ğŸ’¡ ç”Ÿæˆä¿®å¤å»ºè®®
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">åˆ†ææ¦‚è§ˆ</h3>
                        <button class="btn btn-secondary btn-sm" onclick="loadBadCaseAnalysis()">
                            åˆ·æ–°åˆ†æ
                        </button>
                    </div>
                    <div class="grid-3" id="badcase-summary"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æ¨¡å¼è¯†åˆ«</h3>
                    </div>
                    <div id="badcase-patterns"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Bad Case åˆ—è¡¨</h3>
                        <div class="filters">
                            <div class="filter-group">
                                <label>çŠ¶æ€:</label>
                                <select id="filter-status" onchange="loadBadCases()">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="pending">å¾…å¤„ç†</option>
                                    <option value="analyzing">åˆ†æä¸­</option>
                                    <option value="in_progress">ä¿®å¤ä¸­</option>
                                    <option value="fixed">å·²ä¿®å¤</option>
                                    <option value="verified">å·²éªŒè¯</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>ä¸¥é‡ç¨‹åº¦:</label>
                                <select id="filter-severity" onchange="loadBadCases()">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="critical">ä¸¥é‡</option>
                                    <option value="major">é‡è¦</option>
                                    <option value="minor">è½»å¾®</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>ç±»åˆ«:</label>
                                <select id="filter-category" onchange="loadBadCases()">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="intent_confusion">æ„å›¾æ··æ·†</option>
                                    <option value="slot_extraction">æ§½ä½æå–</option>
                                    <option value="fuzzy_expression">æ¨¡ç³Šè¡¨è¾¾</option>
                                    <option value="constraint_violation">çº¦æŸè¿å</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;"><input type="checkbox" id="select-all-badcases" onchange="toggleSelectAllBadCases()"></th>
                                    <th>ç”¨æˆ·è¾“å…¥</th>
                                    <th>æœŸæœ› â†’ å®é™…</th>
                                    <th>ç±»åˆ«</th>
                                    <th>ä¸¥é‡ç¨‹åº¦</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="badcase-list"></tbody>
                        </table>
                    </div>
                    <div style="padding: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <div id="badcase-selection-info" style="color: var(--text-secondary); font-size: 0.875rem;">
                            å·²é€‰æ‹© <span id="selected-count">0</span> é¡¹
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="batchUpdateStatus('analyzing')" id="batch-analyze-btn" disabled>
                                æ ‡è®°åˆ†æä¸­
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="batchUpdateStatus('fixed')" id="batch-fix-btn" disabled>
                                æ ‡è®°å·²ä¿®å¤
                            </button>
                            <button class="btn btn-error btn-sm" onclick="batchDelete()" id="batch-delete-btn" disabled>
                                æ‰¹é‡åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Optimization Page -->
            <div id="optimization" class="page">
                <h2 class="page-title">ğŸ“ˆ ä¼˜åŒ–è¿½è¸ª</h2>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ä¼˜åŒ–è¿›åº¦</h3>
                        <button class="btn btn-primary btn-sm" onclick="showNewRoundModal()">
                            + å¼€å§‹æ–°è½®æ¬¡
                        </button>
                    </div>
                    <div id="optimization-summary"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æŒ‡æ ‡è¶‹åŠ¿</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="optimization-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ä¼˜åŒ–å†å²</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>è½®æ¬¡</th>
                                    <th>ç‰ˆæœ¬</th>
                                    <th>ä¿®å¤/æ–°å¢</th>
                                    <th>å‡†ç¡®ç‡å˜åŒ–</th>
                                    <th>å®Œæˆæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="optimization-history"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Data Management Page -->
            <div id="data" class="page">
                <h2 class="page-title">ğŸ“¦ æ•°æ®ç®¡ç†</h2>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">æ•°æ®å¢å¼º</h3>
                            <button class="btn btn-primary btn-sm" onclick="generateAugmentedData()">
                                ç”Ÿæˆæ•°æ®
                            </button>
                        </div>
                        <div id="augment-stats">
                            <div class="loading">
                                <div class="spinner"></div> åŠ è½½ä¸­...
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Embedding çŸ¥è¯†åº“</h3>
                            <button class="btn btn-primary btn-sm" onclick="buildEmbedding()">
                                é‡å»ºçŸ¥è¯†åº“
                            </button>
                        </div>
                        <div id="embedding-stats">
                            <div class="loading">
                                <div class="spinner"></div> åŠ è½½ä¸­...
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ç”Ÿäº§æ•°æ®</h3>
                        <div>
                            <button class="btn btn-secondary btn-sm" onclick="exportProductionData('jsonl')">
                                å¯¼å‡ºè®­ç»ƒæ•°æ®
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="exportProductionData('fine_tune')">
                                å¯¼å‡º Fine-tune æ•°æ®
                            </button>
                        </div>
                    </div>
                    <div id="production-stats"></div>
                </div>
            </div>

            <!-- Monitor Page -->
            <div id="monitor" class="page">
                <h2 class="page-title">ğŸ” å®æ—¶ç›‘æ§</h2>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">è¯·æ±‚/åˆ†é’Ÿ</div>
                        <div class="metric-value" id="monitor-rpm">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">å¹³å‡å»¶è¿Ÿ</div>
                        <div class="metric-value" id="monitor-latency">-- ms</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">é”™è¯¯ç‡</div>
                        <div class="metric-value" id="monitor-error-rate">--%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">æ´»è·ƒä¼šè¯</div>
                        <div class="metric-value" id="monitor-sessions">--</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">æ„å›¾åˆ†å¸ƒ</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="intent-distribution-chart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ç³»ç»Ÿå¥åº·</h3>
                        </div>
                        <div id="health-status"></div>
                    </div>
                </div>
            </div>

            <!-- System Status Page -->
            <div id="status" class="page">
                <h2 class="page-title">ğŸ’š ç³»ç»ŸçŠ¶æ€</h2>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">ç³»ç»ŸçŠ¶æ€</div>
                        <div class="metric-value" id="status-overall">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">è¿è¡Œæ—¶é—´</div>
                        <div class="metric-value" id="status-uptime">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">API ç‰ˆæœ¬</div>
                        <div class="metric-value" id="status-version">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">ç¯å¢ƒ</div>
                        <div class="metric-value" id="status-env">--</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ç»„ä»¶çŠ¶æ€</h3>
                            <button class="btn btn-secondary btn-sm" onclick="loadSystemStatus()">åˆ·æ–°</button>
                        </div>
                        <div id="status-components">
                            <div class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">åˆ†ç±»å™¨é…ç½®</h3>
                        </div>
                        <div id="status-classifier">
                            <div class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æ”¯æŒçš„æ„å›¾ç±»å‹</h3>
                    </div>
                    <div id="status-intents" class="grid-3"></div>
                </div>
            </div>

            <!-- Business Dashboard Page -->
            <div id="business" class="page">
                <h2 class="page-title">ğŸ“Š ä¸šåŠ¡çœ‹æ¿</h2>

                <div class="metrics-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="metric-card">
                        <div class="metric-label">æ„å›¾å‡†ç¡®ç‡</div>
                        <div class="metric-value" id="biz-accuracy">--</div>
                        <div class="metric-change" id="biz-accuracy-status"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">æ§½ä½ F1</div>
                        <div class="metric-value" id="biz-slot-f1">--</div>
                        <div class="metric-change" id="biz-slot-f1-status"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">è®¢å•æˆåŠŸç‡</div>
                        <div class="metric-value" id="biz-success-rate">--</div>
                        <div class="metric-change" id="biz-success-status"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">äººå·¥ä»‹å…¥ç‡</div>
                        <div class="metric-value" id="biz-escalation">--</div>
                        <div class="metric-change" id="biz-escalation-status"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">å¥åº·åº¦</div>
                        <div class="metric-value" id="biz-health">--</div>
                        <div class="metric-change" id="biz-health-status"></div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">å‘Šè­¦åˆ—è¡¨</h3>
                        </div>
                        <div id="biz-alerts"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">æ”¹è¿›å»ºè®®</h3>
                        </div>
                        <div id="biz-actions"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ä¸šåŠ¡å½±å“åˆ†æ</h3>
                        <button class="btn btn-secondary btn-sm" onclick="loadBusinessDashboard()">åˆ·æ–°</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>æŒ‡æ ‡</th>
                                    <th>å½“å‰å€¼</th>
                                    <th>ç›®æ ‡å€¼</th>
                                    <th>å·®è·</th>
                                    <th>ä¸šåŠ¡å½±å“</th>
                                </tr>
                            </thead>
                            <tbody id="biz-impact-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Workflow Graph Page -->
            <div id="workflow" class="page">
                <h2 class="page-title">ğŸ”€ å·¥ä½œæµå›¾</h2>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">LangGraph å·¥ä½œæµ</h3>
                        <button class="btn btn-secondary btn-sm" onclick="loadWorkflowGraph()">åˆ·æ–°</button>
                    </div>
                    <div id="workflow-diagram" style="padding: 1rem; background: #f8fafc; border-radius: 8px; min-height: 400px;">
                        <div class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">èŠ‚ç‚¹è¯´æ˜</h3>
                    </div>
                    <div class="grid-3" id="workflow-nodes"></div>
                </div>
            </div>

            <!-- A/B Testing Page -->
            <div id="abtesting" class="page">
                <h2 class="page-title">ğŸ§ª A/B æµ‹è¯•</h2>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">åˆ›å»ºå®éªŒ</h3>
                        <button class="btn btn-primary" onclick="showCreateExperimentModal()">
                            + æ–°å»ºå®éªŒ
                        </button>
                    </div>
                    <div class="grid-3">
                        <div class="metric-card">
                            <div class="metric-label">è¿è¡Œä¸­å®éªŒ</div>
                            <div class="metric-value" id="ab-running">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">å·²å®Œæˆå®éªŒ</div>
                            <div class="metric-value" id="ab-completed">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">è‰ç¨¿å®éªŒ</div>
                            <div class="metric-value" id="ab-draft">0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">å®éªŒåˆ—è¡¨</h3>
                        <div class="filters">
                            <div class="filter-group">
                                <label>çŠ¶æ€:</label>
                                <select id="ab-filter-status" onchange="loadExperiments()">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="running">è¿è¡Œä¸­</option>
                                    <option value="completed">å·²å®Œæˆ</option>
                                    <option value="draft">è‰ç¨¿</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>å®éªŒåç§°</th>
                                    <th>å‡è®¾</th>
                                    <th>å˜ä½“</th>
                                    <th>ä¸»è¦æŒ‡æ ‡</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="ab-experiments-list"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" id="ab-analysis-card" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">å®éªŒåˆ†æ</h3>
                        <button class="btn btn-secondary btn-sm" onclick="hideAnalysis()">å…³é—­</button>
                    </div>
                    <div id="ab-analysis-content"></div>
                </div>
            </div>

            <!-- Confusion Matrix Page -->
            <div id="confusion" class="page">
                <h2 class="page-title">ğŸ¯ æ„å›¾æ··æ·†çŸ©é˜µ</h2>

                <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="metric-card">
                        <div class="metric-label">æ•´ä½“å‡†ç¡®ç‡</div>
                        <div class="metric-value" id="confusion-accuracy">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">æœ€æ˜“æ··æ·†æ„å›¾å¯¹</div>
                        <div class="metric-value" id="confusion-worst-pair" style="font-size: 1rem;">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">éœ€å…³æ³¨æ„å›¾æ•°</div>
                        <div class="metric-value" id="confusion-attention-count">--</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æ··æ·†çŸ©é˜µçƒ­åŠ›å›¾</h3>
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-sm" onclick="loadConfusionMatrix()">åˆ·æ–°</button>
                        </div>
                    </div>
                    <div id="confusion-matrix-container" style="overflow-x: auto;">
                        <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">åŠ è½½ä¸­...</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Top æ··æ·†æ¡ˆä¾‹</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>çœŸå®æ„å›¾</th>
                                    <th>é¢„æµ‹æ„å›¾</th>
                                    <th>æ··æ·†æ¬¡æ•°</th>
                                    <th>å…¸å‹æ ·æœ¬</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="confusion-cases-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Training Samples Page -->
            <div id="samples" class="page">
                <h2 class="page-title">ğŸ“ è®­ç»ƒæ ·æœ¬ç®¡ç†</h2>

                <div class="metrics-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="metric-card">
                        <div class="metric-label">æ€»æ ·æœ¬æ•°</div>
                        <div class="metric-value" id="samples-total">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">å·²éªŒè¯</div>
                        <div class="metric-value" id="samples-verified">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">æ‰‹åŠ¨æ·»åŠ </div>
                        <div class="metric-value" id="samples-manual">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">æ„å›¾ç±»å‹æ•°</div>
                        <div class="metric-value" id="samples-intents">--</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">æ ·æœ¬åˆ—è¡¨</h3>
                        <div class="filters">
                            <div class="filter-group">
                                <label>æ„å›¾:</label>
                                <select id="samples-filter-intent" onchange="loadTrainingSamples()">
                                    <option value="">å…¨éƒ¨</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>æ¥æº:</label>
                                <select id="samples-filter-source" onchange="loadTrainingSamples()">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="builtin">å†…ç½®</option>
                                    <option value="manual">æ‰‹åŠ¨æ·»åŠ </option>
                                    <option value="augmented">æ•°æ®å¢å¼º</option>
                                    <option value="production">ç”Ÿäº§æ•°æ®</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <input type="text" id="samples-search" placeholder="æœç´¢æ–‡æœ¬..." onkeyup="debounceSearch()">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="showAddSampleModal()">+ æ·»åŠ æ ·æœ¬</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æ–‡æœ¬</th>
                                    <th>æ„å›¾</th>
                                    <th>æ§½ä½</th>
                                    <th>æ¥æº</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="samples-list"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="samples-pagination"></div>
                </div>

                <!-- Add Sample Modal -->
                <div id="add-sample-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>æ·»åŠ è®­ç»ƒæ ·æœ¬</h3>
                            <button class="btn-close" onclick="hideAddSampleModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>æ–‡æœ¬å†…å®¹</label>
                                <input type="text" id="new-sample-text" placeholder="è¾“å…¥ç”¨æˆ·è¯è¯­...">
                            </div>
                            <div class="form-group">
                                <label>æ„å›¾ç±»å‹</label>
                                <select id="new-sample-intent"></select>
                            </div>
                            <div class="form-group">
                                <label>æ§½ä½ (JSON)</label>
                                <textarea id="new-sample-slots" placeholder='{"product_name": "æ‹¿é“"}'></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="hideAddSampleModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="addTrainingSample()">æ·»åŠ </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Replay Page -->
            <div id="sessions" class="page">
                <h2 class="page-title">ğŸ’¬ ä¼šè¯å›æ”¾</h2>

                <div class="metrics-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="metric-card">
                        <div class="metric-label">æ€»ä¼šè¯æ•°</div>
                        <div class="metric-value" id="sessions-total">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">å·²å®Œæˆ</div>
                        <div class="metric-value" id="sessions-completed">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">è¿›è¡Œä¸­</div>
                        <div class="metric-value" id="sessions-active">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">å¹³å‡æ¶ˆæ¯æ•°</div>
                        <div class="metric-value" id="sessions-avg-messages">--</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ä¼šè¯åˆ—è¡¨</h3>
                            <div class="filters">
                                <select id="sessions-filter-state" onchange="loadSessions()">
                                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="greeting">greeting</option>
                                    <option value="ordering">ordering</option>
                                    <option value="confirming">confirming</option>
                                    <option value="completed">completed</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ä¼šè¯ ID</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ¶ˆæ¯æ•°</th>
                                        <th>æ—¶é•¿</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="sessions-list"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">å¯¹è¯è¯¦æƒ…</h3>
                            <div id="session-detail-header" style="font-size: 0.875rem; color: var(--text-secondary);">
                                é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹è¯¦æƒ…
                            </div>
                        </div>
                        <div id="session-replay-container" style="max-height: 500px; overflow-y: auto; padding: 1rem;">
                            <p style="text-align: center; color: var(--text-secondary);">â† ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¼šè¯</p>
                        </div>
                        <div id="session-summary" style="padding: 1rem; border-top: 1px solid var(--border); display: none;">
                            <h4 style="margin-bottom: 0.5rem;">ä¼šè¯æ‘˜è¦</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem;">
                                <div><strong>æ„å›¾æµ:</strong> <span id="session-intents-flow">--</span></div>
                                <div><strong>æ§½ä½:</strong> <span id="session-slots">--</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let trendChart = null;
        let optimizationChart = null;
        let intentDistributionChart = null;
        let trendData = null;

        // ==================== é¡µé¢å¯¼èˆª ====================
        document.querySelectorAll('.sidebar-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.dataset.page;

                // æ›´æ–°å¯¼èˆªçŠ¶æ€
                document.querySelectorAll('.sidebar-nav a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // æ˜¾ç¤ºé¡µé¢
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');

                // åŠ è½½é¡µé¢æ•°æ®
                loadPageData(pageId);
            });
        });

        // ==================== æ•°æ®åŠ è½½ ====================
        async function loadPageData(pageId) {
            switch (pageId) {
                case 'overview':
                    await loadOverview();
                    break;
                case 'evaluation':
                    await loadEvalHistory();
                    break;
                case 'badcases':
                    await loadBadCases();
                    await loadBadCaseAnalysis();
                    break;
                case 'optimization':
                    await loadOptimizationHistory();
                    break;
                case 'data':
                    await loadDataStats();
                    break;
                case 'monitor':
                    startMonitoring();
                    break;
                case 'status':
                    await loadSystemStatus();
                    break;
                case 'business':
                    await loadBusinessDashboard();
                    break;
                case 'workflow':
                    await loadWorkflowGraph();
                    break;
                case 'abtesting':
                    await loadExperiments();
                    break;
                case 'confusion':
                    await loadConfusionMatrix();
                    break;
                case 'samples':
                    await loadTrainingSamples();
                    break;
                case 'sessions':
                    await loadSessions();
                    break;
            }
        }

        // ==================== æ¦‚è§ˆ ====================
        async function loadOverview() {
            try {
                const [overview, trends] = await Promise.all([
                    fetch('/api/portal/overview').then(r => r.json()),
                    fetch('/api/portal/trends?days=30').then(r => r.json())
                ]);

                // æ›´æ–°æŒ‡æ ‡
                document.getElementById('metric-accuracy').textContent =
                    (overview.metrics.intent_accuracy * 100).toFixed(1) + '%';
                document.getElementById('metric-slot-f1').textContent =
                    (overview.metrics.slot_f1 * 100).toFixed(1) + '%';
                document.getElementById('metric-badcase-rate').textContent =
                    (overview.metrics.bad_case_rate * 100).toFixed(1) + '%';
                document.getElementById('metric-confidence').textContent =
                    (overview.metrics.avg_confidence * 100).toFixed(1) + '%';

                // æ›´æ–°å˜åŒ–
                updateMetricChange('accuracy-change', trends.summary.intent_accuracy_change);
                updateMetricChange('slot-f1-change', trends.summary.slot_f1_change);
                updateMetricChange('badcase-change', trends.summary.bad_case_rate_change, true);

                // æ›´æ–°è®¡æ•°
                document.getElementById('count-pending').textContent = overview.counts.pending_badcases;
                document.getElementById('count-rounds').textContent = overview.counts.optimization_rounds;
                document.getElementById('count-samples').textContent = overview.counts.production_samples;

                // æ›´æ–°å‘Šè­¦
                const alertsHtml = overview.alerts.map(alert => `
                    <div class="alert alert-${alert.level}">
                        <span class="alert-icon">${alert.level === 'error' ? 'âš ï¸' : 'âš¡'}</span>
                        <div class="alert-content">
                            <div class="alert-title">${alert.message}</div>
                            <div class="alert-action">${alert.action}</div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('alerts').innerHTML = alertsHtml;

                // æ›´æ–°æ´»åŠ¨åˆ—è¡¨
                const activityHtml = overview.recent_activity.map(activity => `
                    <li class="activity-item">
                        <div class="activity-icon ${activity.type}">${getActivityIcon(activity.type)}</div>
                        <div class="activity-content">
                            <div>${activity.message}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </li>
                `).join('');
                document.getElementById('activity-list').innerHTML = activityHtml;

                // ä¿å­˜è¶‹åŠ¿æ•°æ®å¹¶æ›´æ–°å›¾è¡¨
                trendData = trends.data;
                updateTrendChart();

            } catch (e) {
                console.error('åŠ è½½æ¦‚è§ˆå¤±è´¥:', e);
            }
        }

        function updateMetricChange(elementId, change, inverse = false) {
            const el = document.getElementById(elementId);
            if (!change) return;

            let direction = change.direction;
            if (inverse) {
                const inverseMap = { 'up': 'down', 'down': 'up' };
                direction = inverseMap[direction] || 'stable';
            }

            const icons = { 'up': 'â†‘', 'down': 'â†“', 'stable': 'â†’' };
            const icon = icons[direction] || 'â†’';
            el.textContent = `${icon} ${Math.abs(change.value).toFixed(1)}%`;
            el.className = `metric-change ${direction}`;
        }

        function getActivityIcon(type) {
            const icons = {
                'eval': 'ğŸ§ª',
                'fix': 'ğŸ”§',
                'data': 'ğŸ“¦',
                'optimize': 'ğŸ“ˆ'
            };
            return icons[type] || 'ğŸ“Œ';
        }

        function updateTrendChart() {
            const metric = document.getElementById('trend-metric').value;
            const ctx = document.getElementById('trend-chart').getContext('2d');

            if (trendChart) {
                trendChart.destroy();
            }

            if (!trendData || trendData.length === 0) return;

            const labels = trendData.map(d => d.date.slice(5)); // MM-DD
            const data = trendData.map(d => d[metric] * 100);

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: metric,
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: v => v + '%'
                            }
                        }
                    }
                }
            });
        }

        // ==================== è¯„ä¼° ====================
        async function loadEvalHistory() {
            try {
                const data = await fetch('/api/portal/eval/results?limit=10').then(r => r.json());

                const html = data.results.map(result => `
                    <tr>
                        <td>${result.date}</td>
                        <td>${result.suite}</td>
                        <td>
                            <span class="badge badge-success">${result.passed} é€šè¿‡</span>
                            ${result.failed > 0 ? `<span class="badge badge-error">${result.failed} å¤±è´¥</span>` : ''}
                        </td>
                        <td>${(result.intent_accuracy * 100).toFixed(1)}%</td>
                        <td>${(result.slot_f1 * 100).toFixed(1)}%</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="showEvalDetail('${result.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('eval-history').innerHTML = html;
            } catch (e) {
                console.error('åŠ è½½è¯„ä¼°å†å²å¤±è´¥:', e);
            }
        }

        async function runEvaluation() {
            const statusEl = document.getElementById('eval-status');
            const progressEl = document.getElementById('eval-progress');
            const taskEl = document.getElementById('eval-task');

            statusEl.style.display = 'block';
            taskEl.textContent = 'å¯åŠ¨è¯„ä¼°...';
            progressEl.style.width = '0%';

            try {
                await fetch('/api/portal/eval/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ suite: 'full' })
                });

                // è½®è¯¢çŠ¶æ€
                const pollStatus = async () => {
                    const status = await fetch('/api/portal/eval/status').then(r => r.json());

                    if (status.running) {
                        taskEl.textContent = `æ­£åœ¨æ‰§è¡Œ: ${status.current_task}`;
                        progressEl.style.width = status.progress + '%';
                        setTimeout(pollStatus, 1000);
                    } else {
                        taskEl.textContent = 'è¯„ä¼°å®Œæˆ!';
                        progressEl.style.width = '100%';
                        await loadEvalHistory();
                    }
                };

                setTimeout(pollStatus, 500);

            } catch (e) {
                console.error('è¿è¡Œè¯„ä¼°å¤±è´¥:', e);
                taskEl.textContent = 'è¯„ä¼°å¤±è´¥: ' + e.message;
            }
        }

        async function showEvalDetail(evalId) {
            try {
                const data = await fetch(`/api/portal/eval/results/${evalId}`).then(r => r.json());

                const testCaseRows = data.test_cases.map((tc, idx) => `
                    <tr style="background: ${tc.passed ? (idx % 2 === 0 ? '#fff' : '#f8fafc') : 'rgba(239, 68, 68, 0.1)'};">
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; max-width: 180px;">${tc.input}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace; font-size: 12px;">${tc.expected_intent}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace; font-size: 12px;">${tc.actual_intent}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace; font-size: 11px; max-width: 150px; word-break: break-all;">${JSON.stringify(tc.expected_slots)}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace; font-size: 11px; max-width: 150px; word-break: break-all;">${JSON.stringify(tc.actual_slots)}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: center;">
                            ${tc.passed
                                ? '<span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 12px;">âœ“ é€šè¿‡</span>'
                                : `<span style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-size: 12px;">âœ— å¤±è´¥</span><div style="color: #991b1b; font-size: 11px; margin-top: 4px;">${tc.error || ''}</div>`}
                        </td>
                    </tr>
                `).join('');

                const modalContent = `
                    <div style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                        <h3 style="margin: 0; font-size: 18px; color: #1e293b;">ğŸ“‹ è¯„ä¼°è¯¦æƒ… - ${data.eval_id}</h3>
                        <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; padding: 0; line-height: 1;">&times;</button>
                    </div>
                    <div style="padding: 20px 24px; background: white;">
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 20px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">å¥—ä»¶</div>
                                <div style="font-weight: 600; color: #1e293b;">${data.suite}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">æ—¶é—´</div>
                                <div style="font-weight: 600; color: #1e293b;">${data.date}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">é€šè¿‡</div>
                                <div style="font-weight: 600; color: #166534; font-size: 20px;">${data.passed}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">å¤±è´¥</div>
                                <div style="font-weight: 600; color: #991b1b; font-size: 20px;">${data.failed}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">æ„å›¾å‡†ç¡®ç‡</div>
                                <div style="font-weight: 600; color: #1e293b;">${(data.intent_accuracy * 100).toFixed(1)}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">æ§½ä½ F1</div>
                                <div style="font-weight: 600; color: #1e293b;">${(data.slot_f1 * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">è¾“å…¥</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">æœŸæœ›æ„å›¾</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">å®é™…æ„å›¾</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">æœŸæœ›æ§½ä½</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">å®é™…æ§½ä½</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0;">ç»“æœ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${testCaseRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; justify-content: flex-end; gap: 12px;">
                        <button onclick="closeModal()" style="padding: 8px 16px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">å…³é—­</button>
                    </div>
                `;

                document.getElementById('modal-content').innerHTML = modalContent;
                document.getElementById('modal-overlay').style.display = 'flex';
            } catch (e) {
                console.error('åŠ è½½è¯„ä¼°è¯¦æƒ…å¤±è´¥:', e);
                alert('åŠ è½½è¯„ä¼°è¯¦æƒ…å¤±è´¥: ' + e.message);
            }
        }

        // ==================== Bad Case ====================
        let selectedBadCases = new Set();

        async function loadBadCases() {
            const status = document.getElementById('filter-status').value;
            const severity = document.getElementById('filter-severity').value;
            const category = document.getElementById('filter-category')?.value;

            try {
                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (severity) params.append('severity', severity);
                if (category) params.append('category', category);

                const data = await fetch(`/api/portal/badcases?${params}`).then(r => r.json());

                if (data.badcases.length === 0) {
                    document.getElementById('badcase-list').innerHTML = `
                        <tr><td colspan="7" class="empty-state">æš‚æ—  Bad Case</td></tr>
                    `;
                    updateBatchButtons();
                    return;
                }

                const html = data.badcases.map(bc => `
                    <tr data-id="${bc.id}">
                        <td><input type="checkbox" class="badcase-checkbox" value="${bc.id}" onchange="toggleBadCaseSelection('${bc.id}')"></td>
                        <td style="max-width: 200px;">${bc.user_input}</td>
                        <td style="font-size: 0.8rem;">
                            <div style="color: #059669;">${bc.expected_intent || '-'}</div>
                            <div style="color: #dc2626;">â†’ ${bc.actual_intent || '-'}</div>
                        </td>
                        <td><span class="badge badge-secondary">${getCategoryLabel(bc.category)}</span></td>
                        <td><span class="badge badge-${getSeverityBadge(bc.severity)}">${getSeverityLabel(bc.severity)}</span></td>
                        <td><span class="badge badge-${getStatusBadge(bc.fix_status)}">${getStatusLabel(bc.fix_status)}</span></td>
                        <td>
                            <div style="display: flex; gap: 4px;">
                                <button class="btn btn-secondary btn-sm" onclick="viewBadCaseDetail('${bc.id}')" title="æŸ¥çœ‹è¯¦æƒ…">ğŸ‘ï¸</button>
                                <button class="btn btn-secondary btn-sm" onclick="markAsFixed('${bc.id}')" title="æ ‡è®°ä¿®å¤">âœ“</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('badcase-list').innerHTML = html;
                selectedBadCases.clear();
                updateBatchButtons();
            } catch (e) {
                console.error('åŠ è½½ Bad Case å¤±è´¥:', e);
            }
        }

        function getCategoryLabel(category) {
            const labels = {
                'intent_confusion': 'æ„å›¾æ··æ·†',
                'slot_extraction': 'æ§½ä½é”™è¯¯',
                'fuzzy_expression': 'æ¨¡ç³Šè¡¨è¾¾',
                'constraint_violation': 'çº¦æŸè¿å',
                'dialogue_context': 'ä¸Šä¸‹æ–‡',
                'other': 'å…¶ä»–'
            };
            return labels[category] || category;
        }

        function getSeverityLabel(severity) {
            const labels = { 'critical': 'ä¸¥é‡', 'major': 'é‡è¦', 'minor': 'è½»å¾®' };
            return labels[severity] || severity;
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'å¾…å¤„ç†',
                'analyzing': 'åˆ†æä¸­',
                'in_progress': 'ä¿®å¤ä¸­',
                'fixed': 'å·²ä¿®å¤',
                'verified': 'å·²éªŒè¯'
            };
            return labels[status] || status;
        }

        function toggleBadCaseSelection(id) {
            if (selectedBadCases.has(id)) {
                selectedBadCases.delete(id);
            } else {
                selectedBadCases.add(id);
            }
            updateBatchButtons();
        }

        function toggleSelectAllBadCases() {
            const selectAll = document.getElementById('select-all-badcases').checked;
            const checkboxes = document.querySelectorAll('.badcase-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedBadCases.add(cb.value);
                } else {
                    selectedBadCases.delete(cb.value);
                }
            });
            updateBatchButtons();
        }

        function updateBatchButtons() {
            const count = selectedBadCases.size;
            document.getElementById('selected-count').textContent = count;
            document.getElementById('batch-analyze-btn').disabled = count === 0;
            document.getElementById('batch-fix-btn').disabled = count === 0;
            document.getElementById('batch-delete-btn').disabled = count === 0;
        }

        async function collectFromEvaluation() {
            try {
                const result = await fetch('/api/portal/badcases/collect-from-eval', {
                    method: 'POST'
                }).then(r => r.json());
                alert(`âœ… å·²ä»è¯„ä¼°ç»“æœæ”¶é›† ${result.collected || 0} ä¸ª Bad Case`);
                loadBadCases();
                loadBadCaseAnalysis();
            } catch (e) {
                alert('æ”¶é›†å¤±è´¥: ' + e.message);
            }
        }

        function showAddBadCaseModal() {
            const modalContent = `
                <div style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
                    <h3 style="margin: 0;">â• æ‰‹åŠ¨æ·»åŠ  Bad Case</h3>
                </div>
                <div style="padding: 20px 24px;">
                    <div class="form-group">
                        <label>ç”¨æˆ·è¾“å…¥</label>
                        <input type="text" id="new-bc-input" placeholder="è¾“å…¥å¯¼è‡´é—®é¢˜çš„ç”¨æˆ·è¯è¯­..." style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>æœŸæœ›æ„å›¾</label>
                            <select id="new-bc-expected" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <option value="ORDER_NEW">ORDER_NEW</option>
                                <option value="ORDER_MODIFY">ORDER_MODIFY</option>
                                <option value="ORDER_CANCEL">ORDER_CANCEL</option>
                                <option value="ORDER_QUERY">ORDER_QUERY</option>
                                <option value="RECOMMEND">RECOMMEND</option>
                                <option value="PRODUCT_INFO">PRODUCT_INFO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å®é™…æ„å›¾</label>
                            <input type="text" id="new-bc-actual" placeholder="ç³»ç»Ÿè¯†åˆ«çš„æ„å›¾" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>ç±»åˆ«</label>
                            <select id="new-bc-category" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <option value="intent_confusion">æ„å›¾æ··æ·†</option>
                                <option value="slot_extraction">æ§½ä½æå–é”™è¯¯</option>
                                <option value="fuzzy_expression">æ¨¡ç³Šè¡¨è¾¾æœªè¯†åˆ«</option>
                                <option value="constraint_violation">çº¦æŸè¿å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ä¸¥é‡ç¨‹åº¦</label>
                            <select id="new-bc-severity" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <option value="critical">ä¸¥é‡</option>
                                <option value="major">é‡è¦</option>
                                <option value="minor">è½»å¾®</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; background: #f8fafc; display: flex; justify-content: flex-end; gap: 12px;">
                    <button onclick="closeModal()" style="padding: 8px 16px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                    <button onclick="addBadCase()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">æ·»åŠ </button>
                </div>
            `;
            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        async function addBadCase() {
            const input = document.getElementById('new-bc-input').value;
            const expected = document.getElementById('new-bc-expected').value;
            const actual = document.getElementById('new-bc-actual').value;
            const category = document.getElementById('new-bc-category').value;
            const severity = document.getElementById('new-bc-severity').value;

            if (!input) {
                alert('è¯·è¾“å…¥ç”¨æˆ·è¯è¯­');
                return;
            }

            try {
                await fetch('/api/portal/badcases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_input: input,
                        expected_intent: expected,
                        actual_intent: actual,
                        category: category,
                        severity: severity
                    })
                });
                closeModal();
                loadBadCases();
                loadBadCaseAnalysis();
                alert('âœ… Bad Case å·²æ·»åŠ ');
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }

        async function batchAnalyze() {
            if (selectedBadCases.size === 0) return;
            alert(`ğŸ” æ­£åœ¨åˆ†æ ${selectedBadCases.size} ä¸ª Bad Case...`);
            await batchUpdateStatus('analyzing');
        }

        async function generateFixSuggestions() {
            alert('ğŸ’¡ æ­£åœ¨ç”Ÿæˆä¿®å¤å»ºè®®...\n\nåŠŸèƒ½å¼€å‘ä¸­ï¼Œå°†è°ƒç”¨ AI åˆ†æ Bad Case æ¨¡å¼å¹¶ç”Ÿæˆä¿®å¤ç­–ç•¥ã€‚');
        }

        async function batchUpdateStatus(status) {
            if (selectedBadCases.size === 0) return;
            try {
                await fetch('/api/portal/badcases/batch-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ids: Array.from(selectedBadCases),
                        status: status
                    })
                });
                loadBadCases();
            } catch (e) {
                alert('æ‰¹é‡æ›´æ–°å¤±è´¥: ' + e.message);
            }
        }

        async function batchDelete() {
            if (selectedBadCases.size === 0) return;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${selectedBadCases.size} ä¸ª Bad Case å—ï¼Ÿ`)) return;
            try {
                await fetch('/api/portal/badcases/batch-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(selectedBadCases) })
                });
                loadBadCases();
                loadBadCaseAnalysis();
            } catch (e) {
                alert('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        async function viewBadCaseDetail(id) {
            // ç®€å•å±•ç¤º Bad Case è¯¦æƒ…
            alert('æŸ¥çœ‹ Bad Case è¯¦æƒ…: ' + id + '\n\nåŠŸèƒ½å¼€å‘ä¸­ï¼Œå°†æ˜¾ç¤ºå®Œæ•´çš„ Bad Case ä¿¡æ¯å’Œä¿®å¤å†å²ã€‚');
        }

        async function markAsFixed(id) {
            if (!confirm('ç¡®å®šå°†æ­¤ Bad Case æ ‡è®°ä¸ºå·²ä¿®å¤å—ï¼Ÿ')) return;
            try {
                await fetch(`/api/portal/badcases/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'fixed' })
                });
                loadBadCases();
            } catch (e) {
                alert('æ›´æ–°å¤±è´¥: ' + e.message);
            }
        }

        async function loadBadCaseAnalysis() {
            try {
                const data = await fetch('/api/portal/badcases/analysis').then(r => r.json());

                // æ‘˜è¦
                const summaryHtml = `
                    <div class="metric-card">
                        <div class="metric-label">æ€» Bad Case</div>
                        <div class="metric-value">${data.total_cases}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">æ„å›¾æ··æ·†</div>
                        <div class="metric-value">${data.by_category?.intent_confusion || 0}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">æ§½ä½é”™è¯¯</div>
                        <div class="metric-value">${data.by_category?.slot_extraction || 0}</div>
                    </div>
                `;
                document.getElementById('badcase-summary').innerHTML = summaryHtml;

                // æ¨¡å¼
                const patternsHtml = data.patterns.map(p => `
                    <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${p.description}</strong>
                                <span class="badge badge-info">${p.count} ä¸ªæ¡ˆä¾‹</span>
                            </div>
                            <span class="badge badge-${p.priority <= 2 ? 'error' : 'warning'}">ä¼˜å…ˆçº§ ${p.priority}</span>
                        </div>
                        <div style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                            å»ºè®®: ${p.suggested_fix}
                        </div>
                    </div>
                `).join('') || '<div class="empty-state">æš‚æ— æ¨¡å¼</div>';
                document.getElementById('badcase-patterns').innerHTML = patternsHtml;

            } catch (e) {
                console.error('åŠ è½½ Bad Case åˆ†æå¤±è´¥:', e);
            }
        }

        // Badge mapping helper
        function getBadgeClass(value, mappings) {
            return mappings[value] || 'pending';
        }

        function getSeverityBadge(severity) {
            return getBadgeClass(severity, { 'critical': 'error', 'major': 'warning', 'minor': 'info' });
        }

        function getStatusBadge(status) {
            return getBadgeClass(status, { 'pending': 'pending', 'fixed': 'success', 'verified': 'success' });
        }

        function viewBadCase(id) {
            alert('æŸ¥çœ‹ Bad Case: ' + id);
        }

        // ==================== ä¼˜åŒ– ====================
        async function loadOptimizationHistory() {
            try {
                const data = await fetch('/api/portal/optimization/history').then(r => r.json());

                // æ‘˜è¦
                const summary = data.summary;
                if (summary && !summary.message) {
                    document.getElementById('optimization-summary').innerHTML = `
                        <div class="grid-3">
                            <div>
                                <div class="metric-label">æ€»è½®æ¬¡</div>
                                <div class="metric-value">${summary.total_rounds || 0}</div>
                            </div>
                            <div>
                                <div class="metric-label">ç´¯è®¡ä¿®å¤</div>
                                <div class="metric-value">${summary.total_badcases_fixed || 0}</div>
                            </div>
                            <div>
                                <div class="metric-label">å‡€å‡å°‘</div>
                                <div class="metric-value">${summary.net_reduction || 0}</div>
                            </div>
                        </div>
                    `;
                }

                // å†å²è¡¨æ ¼
                if (data.rounds && data.rounds.length > 0) {
                    const html = data.rounds.map(r => `
                        <tr>
                            <td>${r.round_id}</td>
                            <td>${r.version.startsWith('v') ? r.version : 'v' + r.version}</td>
                            <td>
                                <span class="badge badge-success">+${r.badcases_fixed}</span>
                                ${r.badcases_new > 0 ? `<span class="badge badge-warning">-${r.badcases_new}</span>` : ''}
                            </td>
                            <td>--</td>
                            <td>${r.completed_at ? r.completed_at.slice(0, 10) : 'è¿›è¡Œä¸­'}</td>
                        </tr>
                    `).join('');
                    document.getElementById('optimization-history').innerHTML = html;
                } else {
                    document.getElementById('optimization-history').innerHTML = `
                        <tr><td colspan="5" class="empty-state">æš‚æ— ä¼˜åŒ–å†å²</td></tr>
                    `;
                }

            } catch (e) {
                console.error('åŠ è½½ä¼˜åŒ–å†å²å¤±è´¥:', e);
            }
        }

        function showNewRoundModal() {
            const version = prompt('è¯·è¾“å…¥ç‰ˆæœ¬å·:', '1.0.0');
            if (version) {
                startNewRound(version);
            }
        }

        async function startNewRound(version) {
            try {
                await fetch('/api/portal/optimization/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        version: version,
                        baseline_metrics: { intent_accuracy: 0.85, slot_f1: 0.80 }
                    })
                });
                alert('æ–°è½®æ¬¡å·²å¼€å§‹!');
                await loadOptimizationHistory();
            } catch (e) {
                alert('å¯åŠ¨å¤±è´¥: ' + e.message);
            }
        }

        // ==================== æ•°æ®ç®¡ç† ====================
        async function loadDataStats() {
            try {
                const [augment, embedding, production] = await Promise.all([
                    fetch('/api/portal/augment/stats').then(r => r.json()),
                    fetch('/api/portal/embedding/stats').then(r => r.json()),
                    fetch('/api/portal/production/stats').then(r => r.json())
                ]);

                // æ•°æ®å¢å¼ºç»Ÿè®¡
                document.getElementById('augment-stats').innerHTML = `
                    <div class="grid-2" style="gap: 1rem;">
                        <div>
                            <div class="metric-label">å•†å“è¯­æ–™</div>
                            <div class="metric-value">${augment.product_corpus_size || 0}</div>
                        </div>
                        <div>
                            <div class="metric-label">å˜ä½“æ€»æ•°</div>
                            <div class="metric-value">${augment.total_variants || 0}</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                        å•†å“: ${(augment.products || []).join(', ')}
                    </div>
                `;

                // Embedding ç»Ÿè®¡
                document.getElementById('embedding-stats').innerHTML = `
                    <div class="grid-2" style="gap: 1rem;">
                        <div>
                            <div class="metric-label">æ€»æ–‡æ¡£æ•°</div>
                            <div class="metric-value">${embedding.total_documents || 0}</div>
                        </div>
                        <div>
                            <div class="metric-label">å±‚æ•°</div>
                            <div class="metric-value">${Object.keys(embedding.by_layer || {}).length}</div>
                        </div>
                    </div>
                `;

                // ç”Ÿäº§æ•°æ®ç»Ÿè®¡
                if (production.total_samples) {
                    document.getElementById('production-stats').innerHTML = `
                        <div class="grid-3" style="gap: 1rem;">
                            <div>
                                <div class="metric-label">æ€»æ ·æœ¬</div>
                                <div class="metric-value">${production.total_samples}</div>
                            </div>
                            <div>
                                <div class="metric-label">å¾…æ ‡æ³¨</div>
                                <div class="metric-value">${production.by_label_status?.pending || 0}</div>
                            </div>
                            <div>
                                <div class="metric-label">è¾¹ç•Œæ¡ˆä¾‹</div>
                                <div class="metric-value">${production.edge_cases_count || 0}</div>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('production-stats').innerHTML = `
                        <div class="empty-state">æš‚æ— ç”Ÿäº§æ•°æ®</div>
                    `;
                }

            } catch (e) {
                console.error('åŠ è½½æ•°æ®ç»Ÿè®¡å¤±è´¥:', e);
            }
        }

        async function generateAugmentedData() {
            try {
                const result = await fetch('/api/portal/augment/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ num_per_intent: 30, edge_cases: 30 })
                }).then(r => r.json());

                alert(`ç”ŸæˆæˆåŠŸ! å…± ${result.generated.total} ä¸ªæ ·æœ¬`);
                await loadDataStats();
            } catch (e) {
                alert('ç”Ÿæˆå¤±è´¥: ' + e.message);
            }
        }

        async function buildEmbedding() {
            try {
                const result = await fetch('/api/portal/embedding/build', {
                    method: 'POST'
                }).then(r => r.json());

                alert(`æ„å»ºæˆåŠŸ! å…± ${result.stats.total_documents} ä¸ªæ–‡æ¡£`);
                await loadDataStats();
            } catch (e) {
                alert('æ„å»ºå¤±è´¥: ' + e.message);
            }
        }

        async function exportProductionData(format) {
            try {
                const result = await fetch(`/api/portal/production/export?format=${format}`, {
                    method: 'POST'
                }).then(r => r.json());

                alert(`å¯¼å‡ºæˆåŠŸ: ${result.file}`);
            } catch (e) {
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }

        // ==================== å®æ—¶ç›‘æ§ ====================
        let monitorInterval = null;

        function startMonitoring() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
            }

            updateMonitorData();
            monitorInterval = setInterval(updateMonitorData, 5000);
        }

        async function updateMonitorData() {
            try {
                const [realtime, health] = await Promise.all([
                    fetch('/api/portal/monitor/realtime').then(r => r.json()),
                    fetch('/api/portal/monitor/health').then(r => r.json())
                ]);

                // æ›´æ–°æŒ‡æ ‡
                document.getElementById('monitor-rpm').textContent = realtime.requests_per_minute;
                document.getElementById('monitor-latency').textContent = realtime.avg_latency_ms + ' ms';
                document.getElementById('monitor-error-rate').textContent = (realtime.error_rate * 100).toFixed(2) + '%';
                document.getElementById('monitor-sessions').textContent = realtime.active_sessions;

                // æ›´æ–°æ„å›¾åˆ†å¸ƒå›¾
                updateIntentDistributionChart(realtime.intent_distribution);

                // æ›´æ–°å¥åº·çŠ¶æ€
                const healthHtml = Object.entries(health.components).map(([name, status]) => `
                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                        <span>${name}</span>
                        <span class="badge badge-${status.status === 'up' ? 'success' : 'error'}">
                            ${status.status === 'up' ? 'æ­£å¸¸' : 'å¼‚å¸¸'}
                        </span>
                    </div>
                `).join('');
                document.getElementById('health-status').innerHTML = healthHtml;

            } catch (e) {
                console.error('æ›´æ–°ç›‘æ§æ•°æ®å¤±è´¥:', e);
            }
        }

        function updateIntentDistributionChart(distribution) {
            const ctx = document.getElementById('intent-distribution-chart').getContext('2d');

            if (intentDistributionChart) {
                intentDistributionChart.destroy();
            }

            const labels = Object.keys(distribution);
            const data = Object.values(distribution);
            const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6'];

            intentDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // ==================== ç³»ç»ŸçŠ¶æ€ ====================
        async function loadSystemStatus() {
            try {
                const data = await fetch('/api/status').then(r => r.json());

                // åŸºæœ¬ä¿¡æ¯
                document.getElementById('status-overall').textContent = data.status === 'ok' ? 'æ­£å¸¸' : 'å¼‚å¸¸';
                document.getElementById('status-overall').style.color = data.status === 'ok' ? 'var(--success)' : 'var(--error)';
                document.getElementById('status-version').textContent = data.version || '1.0.0';
                document.getElementById('status-env').textContent = data.environment || 'development';
                document.getElementById('status-uptime').textContent = formatUptime(data.uptime_seconds);

                // ç»„ä»¶çŠ¶æ€
                const components = data.components || {};
                const componentsHtml = Object.entries(components).map(([name, info]) => `
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                        <div>
                            <strong>${name}</strong>
                            ${info.details ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${info.details}</div>` : ''}
                        </div>
                        <span class="badge badge-${info.status === 'ok' ? 'success' : 'error'}">
                            ${info.status === 'ok' ? 'æ­£å¸¸' : 'å¼‚å¸¸'}
                        </span>
                    </div>
                `).join('');
                document.getElementById('status-components').innerHTML = componentsHtml || '<div class="empty-state">æ— ç»„ä»¶ä¿¡æ¯</div>';

                // åˆ†ç±»å™¨é…ç½®
                const classifier = data.classifier || {};
                document.getElementById('status-classifier').innerHTML = `
                    <div style="padding: 0.5rem 0;"><strong>æ–¹æ³•:</strong> ${classifier.method || '-'}</div>
                    <div style="padding: 0.5rem 0;"><strong>æ¨¡å‹:</strong> ${classifier.model || '-'}</div>
                    <div style="padding: 0.5rem 0;"><strong>å¯ç”¨æ–¹æ³•:</strong> ${(classifier.available_methods || []).join(', ') || '-'}</div>
                `;

                // æ„å›¾ç±»å‹
                const intents = data.supported_intents || [];
                const intentsHtml = intents.map(intent => `
                    <div class="badge badge-info" style="margin: 0.25rem;">${intent}</div>
                `).join('');
                document.getElementById('status-intents').innerHTML = intentsHtml || '<div class="empty-state">æ— æ„å›¾ä¿¡æ¯</div>';

            } catch (e) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', e);
                document.getElementById('status-components').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        function formatUptime(seconds) {
            if (!seconds) return '--';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 24) {
                return `${Math.floor(hours / 24)}å¤©${hours % 24}æ—¶`;
            }
            return `${hours}æ—¶${minutes}åˆ†`;
        }

        // ==================== ä¸šåŠ¡çœ‹æ¿ ====================
        async function loadBusinessDashboard() {
            try {
                const data = await fetch('/api/portal/business/dashboard').then(r => r.json());

                // æ›´æ–°æ‘˜è¦
                const summary = data.summary || {};
                document.getElementById('biz-health').textContent = (summary.health_score || 0).toFixed(0);
                document.getElementById('biz-health-status').innerHTML = `${summary.health_emoji || ''} ${summary.health_text || ''}`;

                // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
                const cardsWidget = (data.widgets || []).find(w => w.type === 'metric_card');
                if (cardsWidget && cardsWidget.data && cardsWidget.data.cards) {
                    const cards = cardsWidget.data.cards;
                    // åç§°åˆ° ID çš„æ˜ å°„
                    const nameToId = {
                        'è®¢å•ç†è§£å‡†ç¡®ç‡': 'accuracy',
                        'æ„å›¾å‡†ç¡®ç‡': 'accuracy',
                        'è®¢å•è¯¦æƒ…å‡†ç¡®ç‡': 'slot-f1',
                        'æ§½ä½ F1': 'slot-f1',
                        'ç‚¹å•æˆåŠŸç‡': 'success-rate',
                        'è®¢å•æˆåŠŸç‡': 'success-rate',
                        'äººå·¥ä»‹å…¥ç‡': 'escalation'
                    };
                    cards.forEach(card => {
                        const id = card.id || nameToId[card.name];
                        if (!id) return;
                        const valueEl = document.getElementById(`biz-${id}`);
                        const statusEl = document.getElementById(`biz-${id}-status`);
                        if (valueEl) {
                            valueEl.textContent = card.value;
                            if (statusEl) {
                                statusEl.innerHTML = `${card.trend || ''} ${card.status_emoji || ''}`;
                                // æ ¹æ®è¶‹åŠ¿ç®­å¤´è®¾ç½®æ ·å¼ç±»
                                let trendClass = '';
                                if (card.trend?.includes('â†‘')) {
                                    trendClass = 'up';
                                } else if (card.trend?.includes('â†“')) {
                                    trendClass = 'down';
                                }
                                statusEl.className = `metric-change ${trendClass}`;
                            }
                        }
                    });
                }

                // æ›´æ–°å‘Šè­¦
                const alertsWidget = (data.widgets || []).find(w => w.type === 'alert_list');
                if (alertsWidget && alertsWidget.data && alertsWidget.data.alerts) {
                    const alertsHtml = alertsWidget.data.alerts.map(a => `
                        <div class="alert alert-${a.level === 'critical' ? 'error' : 'warning'}">
                            <span class="alert-icon">${a.level === 'critical' ? 'ğŸš¨' : 'âš ï¸'}</span>
                            <div class="alert-content">
                                <div class="alert-title">${a.metric}: ${a.message}</div>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('biz-alerts').innerHTML = alertsHtml || '<div class="empty-state">æš‚æ— å‘Šè­¦</div>';
                }

                // æ›´æ–°å»ºè®®
                const actionsWidget = (data.widgets || []).find(w => w.type === 'action_list');
                if (actionsWidget && actionsWidget.data && actionsWidget.data.actions) {
                    const actionsHtml = actionsWidget.data.actions.map((a, i) => `
                        <div style="padding: 0.75rem 0; border-bottom: 1px solid var(--border);">
                            <span class="badge badge-${a.priority === 'high' ? 'error' : 'warning'}">${i + 1}</span>
                            <strong style="margin-left: 0.5rem;">${a.suggestion || a.action || a.metric}</strong>
                            <div style="margin-top: 0.25rem; font-size: 0.875rem; color: var(--text-secondary);">
                                é¢„æœŸæ•ˆæœ: ${a.expected_impact}
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('biz-actions').innerHTML = actionsHtml || '<div class="empty-state">æš‚æ— å»ºè®®</div>';
                }

                // æ›´æ–°å½±å“åˆ†æè¡¨
                const impactWidget = (data.widgets || []).find(w => w.type === 'table');
                if (impactWidget && impactWidget.data && impactWidget.data.rows) {
                    const impactHtml = impactWidget.data.rows.map(row => `
                        <tr>
                            <td>${row.metric}</td>
                            <td>${row.current}</td>
                            <td>${row.target}</td>
                            <td><span class="badge badge-${row.gap?.includes('-') ? 'error' : 'success'}">${row.gap}</span></td>
                            <td>${row.business_impact}</td>
                        </tr>
                    `).join('');
                    document.getElementById('biz-impact-table').innerHTML = impactHtml;
                }

            } catch (e) {
                console.error('åŠ è½½ä¸šåŠ¡çœ‹æ¿å¤±è´¥:', e);
            }
        }

        // ==================== å·¥ä½œæµå›¾ ====================
        async function loadWorkflowGraph() {
            try {
                const data = await fetch('/api/workflow/graph').then(r => r.json());

                // æ¸²æŸ“ Mermaid å›¾
                const mermaidCode = data.mermaid || data.graph || '';
                if (mermaidCode) {
                    document.getElementById('workflow-diagram').innerHTML = `
                        <pre class="mermaid" style="text-align: center;">${mermaidCode}</pre>
                    `;
                    // åŠ¨æ€åŠ è½½ mermaid
                    if (!window.mermaid) {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js';
                        script.onload = () => {
                            mermaid.initialize({ startOnLoad: true, theme: 'default' });
                            mermaid.contentLoaded();
                        };
                        document.head.appendChild(script);
                    } else {
                        mermaid.contentLoaded();
                    }
                } else {
                    document.getElementById('workflow-diagram').innerHTML = '<div class="empty-state">æ— å·¥ä½œæµæ•°æ®</div>';
                }

                // èŠ‚ç‚¹è¯´æ˜
                const nodes = data.nodes || [
                    { name: 'intent_recognition', description: 'æ„å›¾è¯†åˆ«å…¥å£èŠ‚ç‚¹' },
                    { name: 'route_by_intent', description: 'æ ¹æ®æ„å›¾è·¯ç”±åˆ°å¤„ç†èŠ‚ç‚¹' },
                    { name: 'handle_new_order', description: 'å¤„ç†æ–°è®¢å•' },
                    { name: 'handle_modify', description: 'å¤„ç†è®¢å•ä¿®æ”¹' },
                    { name: 'handle_cancel', description: 'å¤„ç†è®¢å•å–æ¶ˆ' },
                    { name: 'handle_query', description: 'å¤„ç†è®¢å•æŸ¥è¯¢' },
                    { name: 'handle_recommend', description: 'å¤„ç†æ¨èè¯·æ±‚' },
                    { name: 'record_message', description: 'è®°å½•æ¶ˆæ¯åˆ°å†å²' }
                ];
                const nodesHtml = nodes.map(n => `
                    <div class="metric-card">
                        <div class="metric-label">${n.name}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">${n.description}</div>
                    </div>
                `).join('');
                document.getElementById('workflow-nodes').innerHTML = nodesHtml;

            } catch (e) {
                console.error('åŠ è½½å·¥ä½œæµå›¾å¤±è´¥:', e);
                document.getElementById('workflow-diagram').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
            }
        }

        // ==================== A/B æµ‹è¯• ====================
        let experiments = [];

        async function loadExperiments() {
            try {
                const data = await fetch('/api/portal/ab/experiments').then(r => r.json());
                experiments = data.experiments || [];

                // ç»Ÿè®¡
                const running = experiments.filter(e => e.status === 'running').length;
                const completed = experiments.filter(e => e.status === 'completed').length;
                const draft = experiments.filter(e => e.status === 'draft').length;

                document.getElementById('ab-running').textContent = running;
                document.getElementById('ab-completed').textContent = completed;
                document.getElementById('ab-draft').textContent = draft;

                // è¿‡æ»¤
                const filterStatus = document.getElementById('ab-filter-status').value;
                let filtered = experiments;
                if (filterStatus) {
                    filtered = experiments.filter(e => e.status === filterStatus);
                }

                // æ¸²æŸ“åˆ—è¡¨
                if (filtered.length === 0) {
                    document.getElementById('ab-experiments-list').innerHTML = `
                        <tr><td colspan="6" class="empty-state">æš‚æ— å®éªŒ</td></tr>
                    `;
                    return;
                }

                const html = filtered.map(exp => `
                    <tr>
                        <td>
                            <strong>${exp.name}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${exp.id}</div>
                        </td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${exp.hypothesis || '-'}</td>
                        <td>${exp.variants?.length || 0} ä¸ª</td>
                        <td>${exp.primary_metric || '-'}</td>
                        <td><span class="badge badge-${getExpStatusBadge(exp.status)}">${getExpStatusText(exp.status)}</span></td>
                        <td>
                            ${exp.status === 'draft' ? `<button class="btn btn-primary btn-sm" onclick="startExperiment('${exp.id}')">å¯åŠ¨</button>` : ''}
                            ${exp.status === 'running' ? `<button class="btn btn-secondary btn-sm" onclick="analyzeExperiment('${exp.id}')">åˆ†æ</button>` : ''}
                            ${exp.status === 'completed' ? `<button class="btn btn-secondary btn-sm" onclick="viewExperiment('${exp.id}')">æŸ¥çœ‹</button>` : ''}
                        </td>
                    </tr>
                `).join('');

                document.getElementById('ab-experiments-list').innerHTML = html;

            } catch (e) {
                console.error('åŠ è½½å®éªŒåˆ—è¡¨å¤±è´¥:', e);
                // æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
                document.getElementById('ab-experiments-list').innerHTML = `
                    <tr><td colspan="6" class="empty-state">æš‚æ— å®éªŒæ•°æ® (API æœªé…ç½®)</td></tr>
                `;
            }
        }

        function getExpStatusBadge(status) {
            return getBadgeClass(status, { 'running': 'success', 'completed': 'info', 'draft': 'pending', 'paused': 'warning', 'aborted': 'error' });
        }

        function getExpStatusText(status) {
            const texts = { 'running': 'è¿è¡Œä¸­', 'completed': 'å·²å®Œæˆ', 'draft': 'è‰ç¨¿', 'paused': 'å·²æš‚åœ', 'aborted': 'å·²ä¸­æ­¢' };
            return texts[status] || status;
        }

        function showCreateExperimentModal() {
            const name = prompt('å®éªŒåç§°:', 'åˆ†ç±»æ–¹æ³•å¯¹æ¯”');
            if (!name) return;

            const hypothesis = prompt('å®éªŒå‡è®¾:', 'few_shot æ–¹æ³•å°†æé«˜ 5% å‡†ç¡®ç‡');
            if (!hypothesis) return;

            createExperiment(name, hypothesis);
        }

        async function createExperiment(name, hypothesis) {
            try {
                await fetch('/api/portal/ab/experiments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        hypothesis: hypothesis,
                        control_config: { method: 'zero_shot' },
                        treatment_config: { method: 'few_shot' },
                        primary_metric: 'intent_accuracy'
                    })
                });
                alert('å®éªŒåˆ›å»ºæˆåŠŸ!');
                await loadExperiments();
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥: ' + e.message);
            }
        }

        async function startExperiment(expId) {
            try {
                await fetch(`/api/portal/ab/experiments/${expId}/start`, { method: 'POST' });
                alert('å®éªŒå·²å¯åŠ¨!');
                await loadExperiments();
            } catch (e) {
                alert('å¯åŠ¨å¤±è´¥: ' + e.message);
            }
        }

        async function analyzeExperiment(expId) {
            try {
                const data = await fetch(`/api/portal/ab/experiments/${expId}/analysis`).then(r => r.json());

                document.getElementById('ab-analysis-card').style.display = 'block';
                document.getElementById('ab-analysis-content').innerHTML = `
                    <div class="grid-2">
                        <div>
                            <h4>å¯¹ç…§ç»„ (Control)</h4>
                            <div>æ ·æœ¬æ•°: ${data.control?.sample_size || '-'}</div>
                            <div>å¹³å‡å€¼: ${data.control?.mean?.toFixed(4) || '-'}</div>
                        </div>
                        <div>
                            <h4>å®éªŒç»„ (Treatment)</h4>
                            <div>æ ·æœ¬æ•°: ${data.treatment?.sample_size || '-'}</div>
                            <div>å¹³å‡å€¼: ${data.treatment?.mean?.toFixed(4) || '-'}</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg); border-radius: 8px;">
                        <strong>ç»Ÿè®¡ç»“æœ:</strong>
                        <div>p-value: ${data.p_value?.toFixed(4) || '-'}</div>
                        <div>æ˜¾è‘—æ€§: ${data.is_significant ? 'æ˜¯' : 'å¦'}</div>
                        <div>ç›¸å¯¹å˜åŒ–: ${data.relative_change ? (data.relative_change * 100).toFixed(2) + '%' : '-'}</div>
                        <div style="margin-top: 0.5rem;"><strong>å»ºè®®:</strong> ${data.recommendation || '-'}</div>
                    </div>
                `;
            } catch (e) {
                alert('åˆ†æå¤±è´¥: ' + e.message);
            }
        }

        // viewExperiment is an alias for analyzeExperiment
        const viewExperiment = analyzeExperiment;

        function hideAnalysis() {
            document.getElementById('ab-analysis-card').style.display = 'none';
        }

        // ==================== æ··æ·†çŸ©é˜µ ====================
        async function loadConfusionMatrix() {
            try {
                const data = await fetch('/api/portal/confusion-matrix').then(r => r.json());

                // æ›´æ–°æŒ‡æ ‡
                document.getElementById('confusion-accuracy').textContent =
                    (data.summary.overall_accuracy * 100).toFixed(1) + '%';

                if (data.summary.most_confused_pair) {
                    document.getElementById('confusion-worst-pair').textContent =
                        `${data.summary.most_confused_pair[0]} â†” ${data.summary.most_confused_pair[1]}`;
                }

                document.getElementById('confusion-attention-count').textContent =
                    data.summary.intents_needing_attention.length;

                // æ¸²æŸ“æ··æ·†çŸ©é˜µè¡¨æ ¼
                renderConfusionMatrix(data.intents, data.matrix);

                // æ¸²æŸ“æ··æ·†æ¡ˆä¾‹
                const casesHtml = data.confusion_cases.map(c => `
                    <tr>
                        <td><span class="badge">${c.true_intent}</span></td>
                        <td><span class="badge badge-warning">${c.predicted_intent}</span></td>
                        <td>${c.count}</td>
                        <td style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${c.examples.slice(0, 2).join('<br>')}
                        </td>
                        <td>
                            <button class="btn btn-sm" onclick="addConfusionSample('${c.true_intent}', '${c.examples[0] || ''}')">
                                æ·»åŠ æ ·æœ¬
                            </button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('confusion-cases-list').innerHTML = casesHtml ||
                    '<tr><td colspan="5" style="text-align: center;">æš‚æ— æ˜¾è‘—æ··æ·†æ¡ˆä¾‹</td></tr>';

            } catch (e) {
                console.error('åŠ è½½æ··æ·†çŸ©é˜µå¤±è´¥:', e);
            }
        }

        function renderConfusionMatrix(intents, matrix) {
            const container = document.getElementById('confusion-matrix-container');

            // è®¡ç®—æœ€å¤§å€¼ç”¨äºé¢œè‰²æ˜ å°„
            let maxVal = 0;
            for (const row of Object.values(matrix)) {
                for (const val of Object.values(row)) {
                    if (val > maxVal) maxVal = val;
                }
            }

            let html = '<table class="confusion-matrix-table" style="font-size: 0.75rem; border-collapse: collapse;">';

            // è¡¨å¤´
            html += '<thead><tr><th style="padding: 0.5rem;">å®é™… \\ é¢„æµ‹</th>';
            for (const intent of intents) {
                const shortName = intent.replace('ORDER_', '').replace('PRODUCT_', '');
                html += `<th style="padding: 0.5rem; writing-mode: vertical-rl; transform: rotate(180deg);">${shortName}</th>`;
            }
            html += '</tr></thead><tbody>';

            // æ•°æ®è¡Œ
            for (const trueIntent of intents) {
                const shortTrue = trueIntent.replace('ORDER_', '').replace('PRODUCT_', '');
                html += `<tr><td style="padding: 0.5rem; font-weight: bold;">${shortTrue}</td>`;

                for (const predIntent of intents) {
                    const val = matrix[trueIntent]?.[predIntent] || 0;
                    const isDiagonal = trueIntent === predIntent;
                    const intensity = maxVal > 0 ? val / maxVal : 0;

                    let bgColor;
                    if (isDiagonal) {
                        // å¯¹è§’çº¿ç”¨ç»¿è‰²è¡¨ç¤ºæ­£ç¡®
                        bgColor = `rgba(16, 185, 129, ${0.2 + intensity * 0.6})`;
                    } else if (val > 5) {
                        // éå¯¹è§’çº¿ç”¨çº¢è‰²è¡¨ç¤ºæ··æ·†
                        bgColor = `rgba(239, 68, 68, ${0.1 + intensity * 0.5})`;
                    } else {
                        bgColor = val > 0 ? `rgba(239, 68, 68, 0.1)` : 'transparent';
                    }

                    html += `<td style="padding: 0.5rem; text-align: center; background: ${bgColor}; min-width: 40px;">
                        ${val > 0 ? val : '-'}
                    </td>`;
                }
                html += '</tr>';
            }

            html += '</tbody></table>';
            html += '<div style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-secondary);">ç»¿è‰²=æ­£ç¡®é¢„æµ‹ | çº¢è‰²=æ··æ·†</div>';

            container.innerHTML = html;
        }

        function addConfusionSample(intent, text) {
            // è·³è½¬åˆ°æ ·æœ¬ç®¡ç†é¡µé¢å¹¶é¢„å¡«
            document.querySelector('[data-page="samples"]').click();
            setTimeout(() => {
                showAddSampleModal();
                document.getElementById('new-sample-text').value = text;
                document.getElementById('new-sample-intent').value = intent;
            }, 300);
        }

        // ==================== è®­ç»ƒæ ·æœ¬ç®¡ç† ====================
        let samplesPage = 1;
        let searchTimeout = null;

        async function loadTrainingSamples() {
            try {
                const intent = document.getElementById('samples-filter-intent').value;
                const source = document.getElementById('samples-filter-source').value;
                const search = document.getElementById('samples-search').value;

                const params = new URLSearchParams({
                    page: samplesPage,
                    page_size: 15
                });
                if (intent) params.append('intent', intent);
                if (source) params.append('source', source);
                if (search) params.append('search', search);

                const data = await fetch(`/api/portal/training-samples?${params}`).then(r => r.json());

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('samples-total').textContent = data.total;
                document.getElementById('samples-intents').textContent = Object.keys(data.intent_counts).length;

                // è®¡ç®—å…¶ä»–ç»Ÿè®¡ï¼ˆç®€åŒ–ï¼‰
                const verifiedCount = data.samples.filter(s => s.verified).length;
                const manualCount = data.samples.filter(s => s.source === 'manual').length;
                document.getElementById('samples-verified').textContent = verifiedCount;
                document.getElementById('samples-manual').textContent = manualCount;

                // å¡«å……æ„å›¾è¿‡æ»¤ä¸‹æ‹‰æ¡†
                const intentSelect = document.getElementById('samples-filter-intent');
                if (intentSelect.options.length <= 1) {
                    for (const [intentName, count] of Object.entries(data.intent_counts)) {
                        const option = document.createElement('option');
                        option.value = intentName;
                        option.textContent = `${intentName} (${count})`;
                        intentSelect.appendChild(option);
                    }

                    // åŒæ—¶å¡«å……æ·»åŠ æ ·æœ¬çš„æ„å›¾ä¸‹æ‹‰æ¡†
                    const newIntentSelect = document.getElementById('new-sample-intent');
                    newIntentSelect.innerHTML = '';
                    for (const intentName of Object.keys(data.intent_counts)) {
                        const option = document.createElement('option');
                        option.value = intentName;
                        option.textContent = intentName;
                        newIntentSelect.appendChild(option);
                    }
                }

                // æ¸²æŸ“è¡¨æ ¼
                const html = data.samples.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${s.text}</td>
                        <td><span class="badge">${s.intent}</span></td>
                        <td style="font-size: 0.8rem; max-width: 150px; overflow: hidden;">
                            ${Object.keys(s.slots || {}).length > 0 ? JSON.stringify(s.slots) : '-'}
                        </td>
                        <td><span class="badge badge-${s.source === 'builtin' ? 'secondary' : 'info'}">${s.source}</span></td>
                        <td>${s.verified ? 'âœ…' : 'â³'}</td>
                        <td>
                            <button class="btn btn-sm" onclick="editSample(${s.id})">ç¼–è¾‘</button>
                            ${s.source !== 'builtin' ? `<button class="btn btn-sm btn-danger" onclick="deleteSample(${s.id})">åˆ é™¤</button>` : ''}
                        </td>
                    </tr>
                `).join('');
                document.getElementById('samples-list').innerHTML = html ||
                    '<tr><td colspan="7" style="text-align: center;">æš‚æ— æ ·æœ¬</td></tr>';

                // æ¸²æŸ“åˆ†é¡µ
                renderSamplesPagination(data.page, data.total_pages);

            } catch (e) {
                console.error('åŠ è½½è®­ç»ƒæ ·æœ¬å¤±è´¥:', e);
            }
        }

        function renderSamplesPagination(current, total) {
            if (total <= 1) {
                document.getElementById('samples-pagination').innerHTML = '';
                return;
            }

            let html = '';
            for (let i = 1; i <= total; i++) {
                html += `<button class="btn btn-sm ${i === current ? 'btn-primary' : ''}"
                    onclick="goToSamplesPage(${i})">${i}</button> `;
            }
            document.getElementById('samples-pagination').innerHTML = html;
        }

        function goToSamplesPage(page) {
            samplesPage = page;
            loadTrainingSamples();
        }

        function debounceSearch() {
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                samplesPage = 1;
                loadTrainingSamples();
            }, 300);
        }

        function showAddSampleModal() {
            document.getElementById('add-sample-modal').style.display = 'flex';
        }

        function hideAddSampleModal() {
            document.getElementById('add-sample-modal').style.display = 'none';
            document.getElementById('new-sample-text').value = '';
            document.getElementById('new-sample-slots').value = '';
        }

        async function addTrainingSample() {
            try {
                const text = document.getElementById('new-sample-text').value.trim();
                const intent = document.getElementById('new-sample-intent').value;
                const slotsText = document.getElementById('new-sample-slots').value.trim();

                if (!text) {
                    alert('è¯·è¾“å…¥æ–‡æœ¬å†…å®¹');
                    return;
                }

                let slots = {};
                if (slotsText) {
                    try {
                        slots = JSON.parse(slotsText);
                    } catch {
                        alert('æ§½ä½ JSON æ ¼å¼é”™è¯¯');
                        return;
                    }
                }

                await fetch('/api/portal/training-samples', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, intent, slots })
                });

                hideAddSampleModal();
                loadTrainingSamples();

            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }

        function editSample(id) {
            alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­... æ ·æœ¬ID: ' + id);
        }

        async function deleteSample(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ ·æœ¬?')) return;

            try {
                await fetch(`/api/portal/training-samples/${id}`, { method: 'DELETE' });
                loadTrainingSamples();
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }

        // ==================== ä¼šè¯å›æ”¾ ====================
        async function loadSessions() {
            try {
                const state = document.getElementById('sessions-filter-state').value;
                const params = new URLSearchParams();
                if (state) params.append('state', state);

                const data = await fetch(`/api/portal/sessions?${params}`).then(r => r.json());

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('sessions-total').textContent = data.total;
                document.getElementById('sessions-completed').textContent = data.state_counts?.completed || 0;
                document.getElementById('sessions-active').textContent =
                    (data.state_counts?.greeting || 0) + (data.state_counts?.ordering || 0);

                const avgMessages = data.sessions.length > 0
                    ? (data.sessions.reduce((sum, s) => sum + s.message_count, 0) / data.sessions.length).toFixed(1)
                    : 0;
                document.getElementById('sessions-avg-messages').textContent = avgMessages;

                // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
                const html = data.sessions.map(s => `
                    <tr onclick="loadSessionDetail('${s.session_id}')" style="cursor: pointer;">
                        <td style="font-family: monospace; font-size: 0.8rem;">${s.session_id.substring(0, 12)}...</td>
                        <td><span class="badge badge-${getStateBadge(s.state)}">${s.state}</span></td>
                        <td>${s.message_count}</td>
                        <td>${s.duration}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); loadSessionDetail('${s.session_id}')">
                                æŸ¥çœ‹
                            </button>
                        </td>
                    </tr>
                `).join('');
                document.getElementById('sessions-list').innerHTML = html ||
                    '<tr><td colspan="5" style="text-align: center;">æš‚æ— ä¼šè¯è®°å½•</td></tr>';

            } catch (e) {
                console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        function getStateBadge(state) {
            const badges = {
                'greeting': 'info',
                'ordering': 'warning',
                'confirming': 'info',
                'completed': 'success'
            };
            return badges[state] || 'secondary';
        }

        // å½“å‰æŸ¥çœ‹çš„ä¼šè¯ID
        let currentSessionId = null;

        async function loadSessionDetail(sessionId) {
            try {
                currentSessionId = sessionId;
                const data = await fetch(`/api/portal/sessions/${sessionId}/messages`).then(r => r.json());

                document.getElementById('session-detail-header').textContent =
                    `ä¼šè¯ ${sessionId.substring(0, 12)}... | ${data.created_at}`;

                // æ¸²æŸ“å¯¹è¯æ¶ˆæ¯
                const messagesHtml = data.messages.map((m, idx) => `
                    <div class="chat-message ${m.role}" style="
                        display: flex;
                        flex-direction: column;
                        align-items: ${m.role === 'user' ? 'flex-end' : 'flex-start'};
                        margin-bottom: 1rem;
                        position: relative;
                    ">
                        <div style="
                            max-width: 80%;
                            padding: 0.75rem 1rem;
                            border-radius: 1rem;
                            background: ${m.role === 'user' ? 'var(--primary)' : 'var(--bg-secondary)'};
                            color: ${m.role === 'user' ? 'white' : 'var(--text-primary)'};
                        ">
                            ${m.content}
                        </div>
                        ${m.intent ? `
                            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: var(--text-secondary);">
                                <span class="badge badge-sm">${m.intent}</span>
                                ${m.confidence ? `(${(m.confidence * 100).toFixed(0)}%)` : ''}
                                ${m.slots && Object.keys(m.slots).length > 0 ? `<span style="margin-left: 0.5rem;">${JSON.stringify(m.slots)}</span>` : ''}
                            </div>
                        ` : ''}
                        <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem; display: flex; align-items: center; gap: 0.5rem;">
                            ${m.timestamp}
                            ${m.role === 'user' ? `
                                <button onclick="showMarkBadCaseModal('${encodeURIComponent(m.content)}', '${m.intent || ''}', '${encodeURIComponent(JSON.stringify(m.slots || {}))}', ${idx})"
                                    style="padding: 2px 6px; font-size: 0.65rem; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer;"
                                    title="æ ‡è®°ä¸º Bad Case">
                                    ğŸ› æ ‡è®°
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

                document.getElementById('session-replay-container').innerHTML = messagesHtml;

                // æ˜¾ç¤ºæ‘˜è¦
                document.getElementById('session-summary').style.display = 'block';
                document.getElementById('session-intents-flow').textContent =
                    data.intents_flow.join(' â†’ ') || 'æ— ';
                document.getElementById('session-slots').textContent =
                    Object.keys(data.slots_extracted).length > 0
                        ? JSON.stringify(data.slots_extracted)
                        : 'æ— ';

            } catch (e) {
                console.error('åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥:', e);
            }
        }

        // ==================== ä»ä¼šè¯æ ‡è®° Bad Case ====================
        function showMarkBadCaseModal(encodedContent, actualIntent, encodedSlots, messageIdx) {
            const content = decodeURIComponent(encodedContent);
            const slots = JSON.parse(decodeURIComponent(encodedSlots));

            const modalContent = `
                <div style="padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                        <h3 style="margin: 0; color: #333;">ğŸ› æ ‡è®°ä¸º Bad Case</h3>
                        <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
                    </div>

                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="font-weight: 600; color: #666; margin-bottom: 0.5rem;">ç”¨æˆ·è¾“å…¥:</div>
                        <div style="font-size: 1.1rem; color: #333;">"${content}"</div>
                        ${actualIntent ? `
                            <div style="margin-top: 0.75rem; display: flex; gap: 1rem; font-size: 0.875rem; color: #666;">
                                <span><strong>è¯†åˆ«æ„å›¾:</strong> ${actualIntent}</span>
                                ${Object.keys(slots).length > 0 ? `<span><strong>æ§½ä½:</strong> ${JSON.stringify(slots)}</span>` : ''}
                            </div>
                        ` : ''}
                    </div>

                    <form id="session-badcase-form" style="display: flex; flex-direction: column; gap: 1rem;">
                        <input type="hidden" id="bc-session-id" value="${currentSessionId || ''}">
                        <input type="hidden" id="bc-message-idx" value="${messageIdx}">
                        <input type="hidden" id="bc-user-input" value="${content}">
                        <input type="hidden" id="bc-actual-intent" value="${actualIntent}">
                        <input type="hidden" id="bc-actual-slots" value='${JSON.stringify(slots)}'>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">æœŸæœ›æ„å›¾</label>
                                <select id="bc-expected-intent" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="ORDER_NEW" ${actualIntent === 'ORDER_NEW' ? 'selected' : ''}>ORDER_NEW</option>
                                    <option value="ORDER_MODIFY" ${actualIntent === 'ORDER_MODIFY' ? 'selected' : ''}>ORDER_MODIFY</option>
                                    <option value="ORDER_CANCEL" ${actualIntent === 'ORDER_CANCEL' ? 'selected' : ''}>ORDER_CANCEL</option>
                                    <option value="ORDER_QUERY" ${actualIntent === 'ORDER_QUERY' ? 'selected' : ''}>ORDER_QUERY</option>
                                    <option value="RECOMMEND" ${actualIntent === 'RECOMMEND' ? 'selected' : ''}>RECOMMEND</option>
                                    <option value="PRODUCT_INFO" ${actualIntent === 'PRODUCT_INFO' ? 'selected' : ''}>PRODUCT_INFO</option>
                                    <option value="CUSTOMIZE" ${actualIntent === 'CUSTOMIZE' ? 'selected' : ''}>CUSTOMIZE</option>
                                    <option value="PAYMENT" ${actualIntent === 'PAYMENT' ? 'selected' : ''}>PAYMENT</option>
                                    <option value="COMPLAINT" ${actualIntent === 'COMPLAINT' ? 'selected' : ''}>COMPLAINT</option>
                                    <option value="CHITCHAT" ${actualIntent === 'CHITCHAT' ? 'selected' : ''}>CHITCHAT</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">ç±»åˆ«</label>
                                <select id="bc-category" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="intent_confusion">æ„å›¾æ··æ·†</option>
                                    <option value="slot_extraction">æ§½ä½æå–é”™è¯¯</option>
                                    <option value="fuzzy_expression">æ¨¡ç³Šè¡¨è¾¾æœªè¯†åˆ«</option>
                                    <option value="constraint_violation">çº¦æŸè¿å</option>
                                    <option value="dialogue_context">å¯¹è¯ä¸Šä¸‹æ–‡é—®é¢˜</option>
                                    <option value="response_quality">å›å¤è´¨é‡é—®é¢˜</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">ä¸¥é‡ç¨‹åº¦</label>
                                <select id="bc-severity" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="critical">ä¸¥é‡ - å½±å“æ ¸å¿ƒåŠŸèƒ½</option>
                                    <option value="major" selected>é‡è¦ - å½±å“ç”¨æˆ·ä½“éªŒ</option>
                                    <option value="minor">è½»å¾® - è¾¹ç¼˜åœºæ™¯</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">æ¥æº</label>
                                <input type="text" value="session_replay" disabled
                                    style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; background: #f5f5f5;">
                            </div>
                        </div>

                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">å¤‡æ³¨</label>
                            <textarea id="bc-notes" rows="2" placeholder="æè¿°é—®é¢˜åŸå› æˆ–å…¶ä»–å¤‡æ³¨..."
                                style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
                        </div>

                        <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 0.5rem;">
                            <button type="button" onclick="closeModal()"
                                style="padding: 0.5rem 1.5rem; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">
                                å–æ¶ˆ
                            </button>
                            <button type="button" onclick="submitSessionBadCase()"
                                style="padding: 0.5rem 1.5rem; background: #ff6b6b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                ğŸ› ç¡®è®¤æ ‡è®°
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('modal-content').innerHTML = modalContent;
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        async function submitSessionBadCase() {
            try {
                const data = {
                    user_input: document.getElementById('bc-user-input').value,
                    expected_intent: document.getElementById('bc-expected-intent').value,
                    actual_intent: document.getElementById('bc-actual-intent').value,
                    actual_slots: JSON.parse(document.getElementById('bc-actual-slots').value || '{}'),
                    category: document.getElementById('bc-category').value,
                    severity: document.getElementById('bc-severity').value,
                    source: 'session_replay',
                    session_id: document.getElementById('bc-session-id').value,
                    notes: document.getElementById('bc-notes').value
                };

                const response = await fetch('/api/portal/badcases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    alert('âœ… Bad Case å·²æ ‡è®°');
                } else {
                    const err = await response.json();
                    alert('âŒ æ ‡è®°å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                console.error('æ ‡è®° Bad Case å¤±è´¥:', e);
                alert('âŒ æ ‡è®°å¤±è´¥: ' + e.message);
            }
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadOverview();
        });

        // é¡µé¢ç¦»å¼€æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (monitorInterval) {
                clearInterval(monitorInterval);
            }
        });
        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }
    </script>

    <!-- General Modal Overlay -->
    <div id="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 99999; justify-content: center; align-items: center;">
        <div id="modal-content" style="background: #ffffff; border-radius: 12px; max-width: 1000px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 25px 80px rgba(0,0,0,0.4);"></div>
    </div>
</body>
</html>
